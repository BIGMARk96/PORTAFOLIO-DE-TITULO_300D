<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Nutricionista</title>
    <link href="./style.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body class="d-flex flex-column min-vh-100">
    <!-- navbar -->
    <header>
        <nav class="navbar">
            <div class="container-fluid">
                <a class="navbar-brand d-flex align-items-center" href="index.html">
                    <img src="image/dumbbells.svg" alt="Logo" width="80" height="74" class="d-inline-block">
                    <span class="brand-text ms-3">Inicia Tu Gym</span>
                </a>
                <div class="d-flex align-items-center">
                    <span class="me-3" id="welcomeMessage"></span>
                    <div class="position-relative d-inline-block me-3">
                        <i class="bi bi-bell-fill fs-5" style="cursor: pointer;" onclick="mostrarNotificaciones()"></i>
                        <span id="notificacionIndicador" class="position-absolute top-0 start-100 translate-middle p-1 bg-danger rounded-circle d-none">
                            <span class="visually-hidden">Notificaciones sin leer</span>
                        </span>
                    </div>
                    <button class="btn btn-outline-custom me-2" type="button" onclick="cerrarSesion()">Salir</button>
                </div>
            </div>
        </nav>
    </header>

    <main class="container py-5 flex-grow-1">
        <div class="row">
            <!-- Información del nutricionista -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-body">
                        <h3 class="text-center mb-4 bg-dark text-white p-2 rounded">Mi Perfil</h3>
                        <div class="text-center mb-4">
                            <img id="fotoPerfil" src="image/perfil.jpg" alt="Foto de perfil" 
                                 class="rounded-circle mb-3" style="width: 150px; height: 150px; object-fit: cover;">
                            <div>
                                <input type="file" id="inputFoto" accept="image/*" class="d-none" onchange="cambiarFotoPerfil(event)">
                                <button class="btn btn-custom-yellow" onclick="document.getElementById('inputFoto').click()">
                                    Cambiar foto
                                </button>
                            </div>
                        </div>
                        <div id="perfilNutri"></div>
                    </div>
                </div>
            </div>

            <!-- Calendario y horarios -->
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-body">
                        <h3 class="text-center mb-4 bg-dark text-white p-2 rounded">Gestión de Horarios</h3>
                        
                        <!-- Selector de fecha -->
                        <div class="mb-4">
                            <label class="form-label">Seleccionar Fecha:</label>
                            <input type="text" class="form-control" id="selectorFecha">
                        </div>

                        <!-- Selector de horas -->
                        <div class="mb-4">
                            <label class="form-label">Horario de Atención:</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <label>Hora inicio:</label>
                                    <input type="time" class="form-control" id="horaInicio">
                                </div>
                                <div class="col-md-6">
                                    <label>Hora fin:</label>
                                    <input type="time" class="form-control" id="horaFin">
                                </div>
                            </div>
                        </div>

                        <!-- Botón para guardar horario -->
                        <button class="btn btn-custom-yellow" onclick="guardarHorario()">Guardar Horario</button>

                        <!-- Lista de horarios guardados -->
                        <div class="mt-4">
                            <h4>Horarios Programados:</h4>
                            <div id="listaHorarios" class="list-group"></div>
                        </div>

                        <!-- Reservas Pendientes -->
                        <div class="card mt-4">
                            <div class="card-body">
                                <h4 class="text-center mb-4 bg-dark text-white p-2 rounded">Reservas Pendientes</h4>
                                <div id="listaReservas" class="list-group"></div>
                            </div>
                        </div>

                        <!-- Reservas Confirmadas -->
                        <div class="card mt-4">
                            <div class="card-body">
                                <h4 class="text-center mb-4 bg-dark text-white p-2 rounded">Reservas Confirmadas</h4>
                                <div id="listaReservasConfirmadas" class="list-group"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="navbar py-3 mt-auto">
        <div class="container d-flex justify-content-between align-items-center">
            <span class="text-white">&copy; 2024 Inicia Tu Gym</span>
            <div class="text-center">
                <p class="text-white">¿Te gustó la herramienta? Apoyar haciendo una donación.</p>
                <a href="https://www.paypal.com/cl/home" target="_blank">
                    <img src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" alt="Donate with PayPal button">
                </a>
            </div>
            <div>
                <a href="https://www.facebook.com" target="_blank" class="text-white me-3">
                    <i class="bi bi-facebook"></i>
                </a>
                <a href="https://www.twitter.com" target="_blank" class="text-white me-3">
                    <i class="bi bi-twitter"></i>
                </a>
                <a href="https://www.instagram.com" target="_blank" class="text-white">
                    <i class="bi bi-instagram"></i>
                </a>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const nutricionista = JSON.parse(localStorage.getItem('nutricionistaActual'));
            if (!nutricionista) {
                window.location.href = 'ingresa-nutri.html';
                return;
            }

            // Cargar foto de perfil si existe
            if (nutricionista.fotoPerfil) {
                document.getElementById('fotoPerfil').src = nutricionista.fotoPerfil;
            }

            // Mostrar información del nutricionista
            document.getElementById('perfilNutri').innerHTML = `
                <p><strong>Nombre:</strong> ${nutricionista.nombre}</p>
                <p><strong>Licencia:</strong> ${nutricionista.numeroLicencia}</p>
                <p><strong>Email:</strong> ${nutricionista.email}</p>
                <p><strong>Previsiones aceptadas:</strong> ${nutricionista.previsiones ? nutricionista.previsiones.map(p => p.toUpperCase()).join(', ') : 'No especificadas'}</p>
            `;

            // Inicializar calendario
            flatpickr("#selectorFecha", {
                dateFormat: "Y-m-d",
                minDate: "today"
            });

            actualizarListaHorarios();
            actualizarListaReservas();
            actualizarListaReservasConfirmadas();
        });

        function guardarHorario() {
            const fecha = document.getElementById('selectorFecha').value;
            const horaInicio = document.getElementById('horaInicio').value;
            const horaFin = document.getElementById('horaFin').value;

            if (!fecha || !horaInicio || !horaFin) {
                alert('Por favor complete todos los campos');
                return;
            }

            const horario = {
                fecha,
                horaInicio,
                horaFin,
                nutricionistaId: JSON.parse(localStorage.getItem('nutricionistaActual')).usuario
            };

            let horarios = JSON.parse(localStorage.getItem('horariosNutri')) || [];
            horarios.push(horario);
            localStorage.setItem('horariosNutri', JSON.stringify(horarios));

            actualizarListaHorarios();
            alert('Horario guardado exitosamente');
        }

        function actualizarListaHorarios() {
            const horarios = JSON.parse(localStorage.getItem('horariosNutri')) || [];
            const nutricionistaId = JSON.parse(localStorage.getItem('nutricionistaActual')).usuario;
            const listaHorarios = document.getElementById('listaHorarios');
            
            listaHorarios.innerHTML = horarios
                .filter(h => h.nutricionistaId === nutricionistaId)
                .map(h => `
                    <div class="list-group-item">
                        Fecha: ${h.fecha} | Horario: ${h.horaInicio} - ${h.horaFin}
                    </div>
                `).join('');
        }

        function actualizarListaReservas() {
            const reservas = JSON.parse(localStorage.getItem('reservasNutri')) || [];
            const nutricionistaId = JSON.parse(localStorage.getItem('nutricionistaActual')).usuario;
            const listaReservas = document.getElementById('listaReservas');
            
            const reservasFiltradas = reservas.filter(r => 
                r.nutricionistaId === nutricionistaId && 
                r.estado === 'pendiente'
            );

            if (reservasFiltradas.length === 0) {
                listaReservas.innerHTML = '<p class="text-muted">No hay reservas pendientes</p>';
                return;
            }

            listaReservas.innerHTML = reservasFiltradas.map(r => `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Usuario:</strong> ${r.nombreUsuario}<br>
                            <strong>Fecha:</strong> ${r.fecha}<br>
                            <strong>Hora:</strong> ${r.hora}
                        </div>
                        <div>
                            <button class="btn btn-custom-yellow me-2" onclick="gestionarReserva('${r.fecha}', '${r.hora}', '${r.usuarioId}', 'confirmada')">
                                Confirmar
                            </button>
                            <button class="btn btn-danger" onclick="gestionarReserva('${r.fecha}', '${r.hora}', '${r.usuarioId}', 'rechazada')">
                                Rechazar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function actualizarListaReservasConfirmadas() {
            const reservas = JSON.parse(localStorage.getItem('reservasNutri')) || [];
            const usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
            const nutricionistaId = JSON.parse(localStorage.getItem('nutricionistaActual')).usuario;
            const listaReservasConfirmadas = document.getElementById('listaReservasConfirmadas');
            
            const reservasConfirmadas = reservas.filter(r => 
                r.nutricionistaId === nutricionistaId && 
                r.estado === 'confirmada'
            );

            if (reservasConfirmadas.length === 0) {
                listaReservasConfirmadas.innerHTML = '<p class="text-muted">No hay reservas confirmadas</p>';
                return;
            }

            listaReservasConfirmadas.innerHTML = reservasConfirmadas.map(r => {
                const usuario = usuarios.find(u => u.usuario === r.usuarioId);
                return `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Usuario:</strong> ${r.nombreUsuario}<br>
                                <strong>Email:</strong> ${usuario ? usuario.email : 'No disponible'}<br>
                                <strong>Fecha:</strong> ${r.fecha}<br>
                                <strong>Hora:</strong> ${r.hora}
                            </div>
                            <span class="badge bg-warning">Confirmada</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function gestionarReserva(fecha, hora, usuarioId, estado) {
            let reservas = JSON.parse(localStorage.getItem('reservasNutri')) || [];
            const nutricionistaActual = JSON.parse(localStorage.getItem('nutricionistaActual'));
            
            reservas = reservas.map(r => {
                if (r.fecha === fecha && r.hora === hora && 
                    r.usuarioId === usuarioId && r.nutricionistaId === nutricionistaActual.usuario) {
                    return { ...r, estado };
                }
                return r;
            });

            localStorage.setItem('reservasNutri', JSON.stringify(reservas));
            
            // Agregar notificación para el usuario
            const mensaje = estado === 'confirmada' 
                ? `Tu hora para el día ${fecha} a las ${hora} ha sido confirmada por Dr(a). ${nutricionistaActual.nombre}`
                : `Tu hora para el día ${fecha} a las ${hora} ha sido rechazada por Dr(a). ${nutricionistaActual.nombre}`;
            
            agregarNotificacion(usuarioId, mensaje, estado);
            
            actualizarListaReservas();
            actualizarListaReservasConfirmadas();
            alert(`Reserva ${estado} exitosamente`);
        }
    </script>
</body>
</html> 